<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <title>Sign Up</title>
</head>
<body>
    <h2>회원가입</h2>
    <form th:action="@{/api/users}" method="post" onsubmit="return validateForm()">
        <div>
            <label for="loginId">Login ID:</label>
            <input type="text" id="loginId" name="loginId" required>
            <button type="button" id="checkId" onclick="checkDuplicateId()">중복 확인</button>
            <span id="idResult"></span>
        </div>
        <div>
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>
        </div>
        <div>
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required>
        </div>
        <div>
            <label for="nickname">Nickname:</label>
            <input type="text" id="nickname" name="nickname">
            <button type="button" id="checkNickname" onclick="checkDuplicateNickname()">중복 확인</button>
            <span id="nicknameResult"></span>
        </div>
        <div>
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
        </div>
        <div>
            <button type="submit">Sign Up</button>
        </div>
    </form>

<script>
    let isIdAvailable = false;
    let isNicknameAvailable = false;

    //공통 fetch 함수
    function fetchData(url, method) {
        return fetch(url, {
            method: method
        })
            .then(response => { //성공
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .catch(error => { //실패
                console.error('Error:', error);
                throw error;
            });
    }

    //아이디 중복체크
    function checkDuplicateId() {
        let loginId = document.getElementById("loginId").value;
        let url = '/api/users/checkDuplicateId?loginId=' + encodeURIComponent(loginId);
        let method = 'GET';

        fetchData(url, method)
            .then(data => { //성공 시
                let resultElement = document.getElementById('idResult');
                if (data) {
                    resultElement.textContent = '이미 사용 중인 아이디입니다.';
                    resultElement.style.color = 'red';
                    isIdAvailable = false;
                } else {
                    resultElement.textContent = '사용 가능한 아이디입니다.';
                    resultElement.style.color = 'green';
                    isIdAvailable = true;
                }
            })
            .catch(error => { //실패 시
                console.error('Error in checkDuplicateId:', error);
                alert('아이디 중복 체크 중 오류가 발생했습니다.');
            });
    }

    //닉네임 중복체크
    function checkDuplicateNickname() {
        let nickname = document.getElementById('nickname').value;
        let url = '/api/users/checkDuplicateNickname?nickname=' + encodeURIComponent(nickname);
        let method = 'GET';

        fetchData(url, method)
            .then(data => { //성공 시
                let resultElement = document.getElementById('nicknameResult');
                if (data) {
                    resultElement.textContent = '이미 사용 중인 닉네임입니다.';
                    resultElement.style.color = 'red';
                    isNicknameAvailable = false;
                } else {
                    resultElement.textContent = '사용 가능한 닉네임입니다.';
                    resultElement.style.color = 'green';
                    isNicknameAvailable = true;
                }
            })
            .catch(error => { //실패 시
                console.error('Error in checkDuplicateNickname:', error);
                alert('닉네임 중복 체크 중 오류가 발생했습니다.');
            });
    }

    //아이디 형식 체크(숫자+영문자 조합)
    function validateLoginId() {
        let loginId = document.getElementById("loginId").value;
        let regex = /^(?=.*[a-zA-Z])(?=.*[0-9])[0-9a-zA-Z]+$/;

        if(!regex.test(loginId)) {
            alert("loginId는 영문자와 숫자를 혼합하여 입력해주세요.");
            document.getElementById("loginId").focus();
            return false;
        }

        return true;
    }

    //비밀번호 형식 체크(숫자+영문자, 8자 이상)
    function validatePassword() {
        let password = document.getElementById("password").value;
        let regex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;

        if(!regex.test(password)) {
            alert("비밀번호는 최소 8자 이상이어야 하며, 영문자와 숫자를 혼합하여 입력해주세요.");
            document.getElementById("password").focus();
            return false;
        }

        return true;
    }

    //최종 검증
    function validateForm() {
        if (!validateLoginId()) {
            return false;
        }

        if(!validatePassword()) {
            return false;
        }

        if (!isIdAvailable) {
            alert("아이디 중복 확인을 해주세요.");
            return false;
        }

        if(!isNicknameAvailable) {
            alert("닉네임 중복 확인을 해주세요.");
            return false;
        }
        return true;
    }
</script>
</body>
</html>