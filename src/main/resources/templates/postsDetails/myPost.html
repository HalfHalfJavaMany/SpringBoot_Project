<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title id="postTitle"> 상세 보기</title>
    <link rel="stylesheet" href="/css/postDetails.css">
</head>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<body>
<main>
    <h1 id="detailTitle" style="text-align: center"></h1>
    <div id="titleLine"></div>
    <div class="area-post-detail">
        <p class="author">작성자 : <span id="userName"></span></p>
        <p class="dates">작성된 날짜 : <span id="created"></span></p>
    </div>
    <p style="text-align: right">수정된 날짜 : <span id="updated"></span></p>
    <ul id="starImg"></ul>
    <p id="postBody"></p>
    <div id="btn-list">
        <ul class="btn-list-ul">
            <li>
                <button id="category" class="btn-text"></button>
            </li>
            <li>
                <button id="location" class="btn-text"></button>
            </li>
        </ul>
        <ul class="btn-list-ul" id="hashtag">
        </ul>
    </div>
    <div class="btn-update-delete-area">
        <button class="btn-square" id="btn-update">
            수정
        </button>
        <button class="btn-square" id="btn-delete">
            삭제
        </button>
        <button class="btn-square">
            목록으로
        </button>

    </div>
</main>
<div id="commentLine"></div>
<section id="sectionComment">
    <h3 id="comment-notice">댓글 쓰기</h3>
    <label for="comment-body">
        <textarea id="comment-body" placeholder="내용을 입력해 주세요." required></textarea>
        <button type="submit" class="btn-square" id="btn-comment-submit">등록</button>
    </label>
</section>
<div id="div-comment"></div>
</body>
<script>
    let star = 0;
    let hashtags = '';
    const image = document.querySelector('#starImg');
    const hashtag = document.querySelector('#hashtag');
    const btnUpdate = document.querySelector('#btn-update');
    const btnDelete = document.querySelector('#btn-delete');
    let postUrl = window.location.href;
    const urlParams = new URL(location.href).searchParams;
    let isUser;
    let username;

    console.log(postUrl);
    getInit();
    notUser();

    $('#btn-comment-submit').on('click', function (event) {
        event.preventDefault();

        if (username === null) {
            alert("로그인이 필요합니다.");
            location.href = postUrl;
            return false;
        }

        let commentDto = {
            body: $('#comment-body').val(),
            createdAt: null,
            updatedAt: null
        }

        $.ajax({
            method: "POST",
            url: 'http://localhost:8080/api/comments/nonreply?postId=' + urlParams.get('postId'),
            data: JSON.stringify(commentDto),
            contentType: 'application/json',
            dataType: 'json',
            success: function (response) {
                alert('코멘트 등록 성공');
                location.href = postUrl;
            },
            error: function (error) {
                alert('등록에 실패했습니다')
            }
        })
    })

    function notUser() {
        if (isUser === false) {
            btnDelete.remove();
            btnUpdate.remove();
        }
    }

    function getInit() {
        $.ajax({
            type: "GET",
            url: "/api/posts/" + urlParams.get('postId'),
            success: function (data) {
                $('#postBody').text(data.body);
                $('#postTitle').text(data.title);
                $('#detailTitle').text(data.title);
                $('#updated').text(data.updatedAt);
                $('#created').text(data.createdAt);
                $('#userName').text(data.usersDto.nickname);
                $('#category').text(data.category);
                $('#location').text(data.location);
                isUser = data.usersDto.isEqual;
                username = data.usersDto.loginId;
                for (let i = 0; i < data.star; i++) {
                    image.insertAdjacentHTML('beforeend', '<img src="/img/star.png" height="41" width="41" alt="별점 이미지입니다."/>');
                }

                var splitHashtags = data.hashtags.split('/');
                for (let i = 0; i < splitHashtags.length; i++) {
                    hashtag.insertAdjacentHTML('beforeend',
                        '<li><button class="btn-hashtags"><span class="btn-text">' + splitHashtags[i] + '</span></button></li>');
                }

                hashtags = data.hashtags;
            },
            error: function (error) {
                alert('조회에 실패했습니다.');
            }
        });

        $.ajax({
            type: "GET",
            url: "/api/comments/get/" + urlParams.get('postId'),
            success: function (data) {
                renderComment(data, $('#div-comment'));
            },
            error: function (error) {
                alert("조회에 실패했습니다.");
            }
        })

        function renderComment(comments, container) {
            comments.forEach(function (comment) {
                const marginLeft = (comment.depth + 1) * 27;
                const commentHTML = `
                    <div class="comment" data-id="${comment.id}" data-user-id="${comment.loginId}">
                        <div class="comment-sec">
                            <p class="comment-author">${comment.author}</p>
                            <div class="comment-body-date">
                                <p class="comment-body" id="comment-body-${comment.id}">${comment.body}</p>
                                <p class="comment-date">최종 수정 날짜: ${comment.updatedAt}</p>
                            </div>
                            <div class="comment-btn">
                                <button class="edit-btn btn-square-small" data-comment-id="${comment.id}">수정</button>
                                <button class="delete-btn btn-square-small" data-comment-id="${comment.id}">삭제</button>
                            </div>
                        </div>
                        <div class="replies" style="margin-left: ${marginLeft}px;"></div>
                    </div>`;
                const commentElement = $(commentHTML);
                container.append(commentElement);
                renderComment(comment.children, commentElement.find('.replies'));
                if (comment.loginId !== username || comment.activated === false) {
                    commentElement.find('.edit-btn').hide();
                    commentElement.find('.delete-btn').hide();
                }
                console.log(comment);
            })
        }

        $('#div-comment').on('click', '.delete-btn', function () {
            const commentId = $(this).closest('.comment').data('id');
            deleteComment(commentId);
        });

        $('#div-comment').on('click', '.edit-btn', function () {
            const commentId = $(this).data('comment-id');
            const commentTextElement = $(`#comment-body-${commentId}`);
            const commentText = commentTextElement.text();

            if (!$(`#edit-textarea-${commentId}`).length) {
                const textarea = $(`<textarea id="edit-textarea-${commentId}" class="edit-textarea">${commentText}</textarea>`);
                commentTextElement.replaceWith(textarea);
            }

            $(this).text('저장').removeClass('edit-btn').addClass('save-btn');
        });

        $('#div-comment').on('click', '.save-btn', function () {
            const commentElement = $(this).closest('.comment');
            const commentId = commentElement.data('id');
            const textarea = commentElement.find('.edit-textarea');
            const newText = textarea.val();

            if (newText) {
                editComment(commentId, newText);
            }
        });


        function deleteComment(commentId) {
            $.ajax({
                url: '/api/comments/delete/' + commentId,
                method: 'DELETE',
                contentType: 'application/json',
                data: {},
                success: function (response) {
                    alert("댓글 삭제에 성공했습니다.");
                    location.href = postUrl;

                },
                error: function (error) {
                    alert('댓글 삭제에 실패했습니다.');
                    location.href = postUrl;
                }
            });
        }

        function editComment(commentId, newText) {
            $.ajax({
                url: '/api/comments/update/' + commentId,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    body: newText,
                    createdAt: null,
                    updatedAt: null
                }),
                success: function (response) {
                    alert("댓글 수정에 성공했습니다.");
                    location.href = postUrl;

                },
                error: function (error) {
                    alert('댓글 수정에 실패했습니다.');
                    location.href = postUrl;
                }
            });
        }
    }


</script>
</html>